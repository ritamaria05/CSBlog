---
import LayoutBase from "../layouts/LayoutBase.astro";
import { getCollection, type CollectionEntry } from "astro:content";
const theoryPosts = await getCollection("theory");
const projectPosts = await getCollection("projects");
const allPosts = [...theoryPosts.map(post => ({...post, collection: 'theory'})), ...projectPosts.map(post => ({...post, collection: 'projects'}))];

---
<LayoutBase title="Search">
    <div class="max-w-2xl mx-auto py-10">
        <h1 class="text-3xl font-bold mb-6">What are you looking for?</h1>
        
        <div class="relative mb-10">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Ex: java, algorithms, api..." 
                class="w-full p-4 pl-12 rounded-xl border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-lg"
            >
            <span class="absolute left-4 top-4 text-xl opacity-50">üîç</span>
        </div>

        <div id="results-container" class="space-y-4">
            <p class="text-center text-gray-500 mt-10">Start typing to find posts...</p>
        </div>
    </div>

    <script define:vars={{ allPosts }}>
        // Astro passes the 'allPosts' variable from the server to here
        
        const input = document.getElementById('search-input');
        const resultsDiv = document.getElementById('results-container');

        // Function to read URL params (e.g., if you came from the Dropdown ?q=java)
        const params = new URLSearchParams(window.location.search);
        const initialQuery = params.get('q');

        if (initialQuery) {
            input.value = initialQuery;
            performSearch(initialQuery);
        }

        input.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        function performSearch(query) {
            if (!query) {
                resultsDiv.innerHTML = '<p class="text-center text-gray-500">Start typing...</p>';
                return;
            }

            const term = query.toLowerCase();

            // Filtering Logic: Search in Title, Description, and Tags
            const filtered = allPosts.filter(post => {
                const inTitle = post.title.toLowerCase().includes(term);
                const inTags = post.tags.some(tag => tag.toLowerCase().includes(term));
                return inTitle || inTags;
            });

            // Render Results
            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-gray-500">Nothing found. Try another word!</p>';
            } else {
                resultsDiv.innerHTML = filtered.map(post => `
                    <a href="/${post.type}/${post.slug}" class="block p-6 bg-white rounded-lg border hover:border-blue-500 hover:shadow-md transition group">
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-bold text-gray-900 group-hover:text-blue-600">${post.title}</h2>
                            <span class="text-xs font-bold uppercase px-2 py-1 rounded ${post.type === 'projects' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                ${post.type === 'projects' ? 'Project' : 'Theory'}
                            </span>
                        </div>
                        <p class="text-gray-600 mt-2">${post.description}</p>
                        <div class="mt-3 flex gap-2">
                            ${post.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">#${tag}</span>`).join('')}
                        </div>
                    </a>
                `).join('');
            }
        }
    </script>
</LayoutBase>